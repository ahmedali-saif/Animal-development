<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البحث في بيانات تربية الدواجن</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
        }
        .header-gradient {
            background: linear-gradient(90deg, #1e3a8a 0%, #3b82f6 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        /* Spinner animation */
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .search-btn {
            transition: all 0.3s ease;
        }
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(59, 130, 246, 0.3);
        }
        .result-card {
            transition: all 0.3s ease;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header Card -->
        <div class="bg-white rounded-2xl card-shadow overflow-hidden mb-8">
            <div class="header-gradient py-6 px-6 text-white">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="text-center md:text-right mb-4 md:mb-0">
                        <h1 class="text-3xl md:text-4xl font-bold mb-2">أداة البحث في أعمال قسم التنمية الحيوانية</h1>
                        <p class="text-blue-100 text-lg">البحث المباشر في قاعدة بيانات أعمال قسم التنمية الحيوانية </p>
                    </div>
                    <div class="bg-white bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-database text-3xl"></i>
                    </div>
                </div>
            </div>

            <!-- Search Section -->
            <div class="p-6 md:p-8">
                <div class="mb-2">
                    <div class="flex items-center text-gray-600 mb-1">
                        <i class="fas fa-search ml-2"></i>
                        <span>ابحث في قاعدة البيانات</span>
                    </div>
                    <p class="text-gray-500 text-sm mb-6">أدخل كلمة للبحث عن المعلومات</p>
                </div>

                <!-- Sheet Selection -->
                <div class="mb-6">
                    <label for="sheetSelect" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-layer-group ml-2"></i>
                        اختر نوع الزيارة الميدانية للبحث
                    </label>
                    <select id="sheetSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300 text-lg bg-white">
                        <option value="" selected>-- اختر نوع الزيارة --</option>
                        <option value="تربية الدواجن اللاحم">تربية الدواجن اللاحم</option>
                        <option value="تربية الدواجن البياض">تربية الدواجن البياض</option>
                    </select>
                </div>

                <div class="flex flex-col md:flex-row gap-4 mb-2">
                    <div class="flex-grow relative">
                        <input type="text" id="searchInput" placeholder="ابحث عن القائم بالزيارة, اسم الموظف,اسم المشروع /المصنع/الموقع الرعوي....." 
                               class="w-full px-5 py-4 pr-12 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300 text-lg">
                        <i class="fas fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button id="searchButton" class="search-btn bg-blue-600 text-white px-8 py-4 rounded-xl font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 flex items-center justify-center">
                        <i class="fas fa-search mr-2"></i>
                        بحث
                    </button>
                </div>
                <div class="flex flex-wrap gap-2 mt-4">
                    <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">امراض الدواجن</span>
                    <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">اللقاحات</span>
                    <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">الادوية البيطرية</span>
                    <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">التغذية</span>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsContainer" class="bg-white rounded-2xl card-shadow overflow-hidden">
            <!-- Loading Spinner -->
            <div id="loader" class="hidden flex flex-col justify-center items-center my-12 py-8">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4"></div>
                <p class="text-gray-600 font-medium">جاري تحميل البيانات...</p>
            </div>

            <!-- No Results Message -->
            <div id="noResults" class="hidden text-center my-12 p-8">
                <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-8 max-w-md mx-auto">
                    <i class="fas fa-search text-yellow-500 text-5xl mb-4"></i>
                    <h3 class="text-xl font-bold text-yellow-800 mb-2">لم نعثر على نتائج</h3>
                    <p class="text-yellow-700">لم يتم العثور على نتائج مطابقة لكلمة البحث. حاول استخدام كلمات أخرى.</p>
                </div>
            </div>

            <!-- Results Cards -->
            <div id="cardsContainer" class="hidden p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">نتائج البحث</h2>
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full" id="resultsCount"></div>
                        <div class="text-sm text-blue-600 bg-blue-100 px-3 py-1 rounded-full" id="currentSheet"></div>
                    </div>
                </div>
                <div id="resultsCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Results cards will be inserted here dynamically -->
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>&copy; 2025 - أداة بحث في أعمال قسم التنمية الحيوانية</p>
        </footer>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SHEET_ID = '1hyQubL4sP2ehU5T_lY5ZQfxAImgrJP2JC1LmlpvQbOI';
        const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=`;

        // --- DOM ELEMENTS ---
        const searchButton = document.getElementById('searchButton');
        const searchInput = document.getElementById('searchInput');
        const sheetSelect = document.getElementById('sheetSelect');
        const resultsContainer = document.getElementById('resultsContainer');
        const loader = document.getElementById('loader');
        const noResults = document.getElementById('noResults');
        const cardsContainer = document.getElementById('cardsContainer');
        const resultsCards = document.getElementById('resultsCards');
        const resultsCount = document.getElementById('resultsCount');
        const currentSheet = document.getElementById('currentSheet');

        let sheetData = {}; // To cache the fetched data for each sheet

        // --- FUNCTIONS ---

        /**
         * Fetches and parses data from the Google Sheet.
         * Caches the data to avoid re-fetching on every search.
         */
        async function fetchSheetData(sheetName) {
            // Check if data for this sheet is already cached
            if (sheetData[sheetName] && sheetData[sheetName].length > 0) {
                return sheetData[sheetName];
            }

            loader.classList.remove('hidden');
            cardsContainer.classList.add('hidden');
            noResults.classList.add('hidden');

            try {
                const response = await fetch(GOOGLE_SHEET_URL + encodeURIComponent(sheetName));
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const jsonText = await response.text();
                // معالجة النص لتحويله إلى JSON صالح
                const jsonData = JSON.parse(jsonText.substring(47).slice(0, -2));
                sheetData[sheetName] = parseGoogleSheetData(jsonData);
                // --- حساب عدد الصفوف التي تحتوي على بيانات حقيقية (عدد الزيارات الميدانية) ---
const validRows = sheetData[sheetName].filter(row =>
    Object.values(row).some(value => value && value.trim() !== '')
);
const visitCount = validRows.length;

// --- عرض عدد الزيارات الميدانية أسفل مربع البحث ---
let visitCountElement = document.getElementById('visitCount');
if (!visitCountElement) {
    const searchSection = document.querySelector('.flex.flex-col.md\\:flex-row.gap-4.mb-2');
    if (searchSection) {
        visitCountElement = document.createElement('div');
        visitCountElement.id = 'visitCount';
        visitCountElement.className = 'text-right mt-3 text-gray-700 font-semibold text-lg';
        visitCountElement.innerHTML = `
            <span class="text-blue-700">عدد الزيارات الميدانية:</span> 
            <span class="text-gray-900">${visitCount}</span>
        `;
        searchSection.insertAdjacentElement('afterend', visitCountElement);
    }
} else {
    visitCountElement.innerHTML = `
        <span class="text-blue-700">عدد الزيارات الميدانية:</span> 
        <span class="text-gray-900">${visitCount}</span>
    `;
}

                console.log('Data loaded successfully for sheet:', sheetName, sheetData[sheetName]);
                return sheetData[sheetName];
            } catch (error) {
                console.error('Error fetching or parsing sheet data:', error);
                resultsContainer.innerHTML = `
                    <div class="text-center my-12 p-8">
                        <div class="bg-red-50 border border-red-200 rounded-2xl p-8 max-w-md mx-auto">
                            <i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4"></i>
                            <h3 class="text-xl font-bold text-red-800 mb-2">حدث خطأ</h3>
                            <p class="text-red-700">حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.</p>
                            <p class="text-red-700 text-sm mt-2">${error.message}</p>
                        </div>
                    </div>`;
                return [];
            } finally {
                loader.classList.add('hidden');
            }
        }
        
        /**
         * Parses Google Sheet JSON data into an array of objects.
         * @param {Object} data - The Google Sheet data.
         * @returns {Array<Object>} An array of row objects.
         */
        function parseGoogleSheetData(data) {
            if (!data || !data.table || !data.table.cols || !data.table.rows) {
                return [];
            }
            
            const headers = data.table.cols.map(col => col.label || '');
            // Limit headers to columns A-T (first 20 columns)
            const limitedHeaders = headers.slice(0, 20);
            
            const rows = data.table.rows;
            const result = [];
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const rowData = {};
                
                // Limit values to columns A-T (first 20 columns)
                const limitedCells = row.c.slice(0, 20);
                
                limitedHeaders.forEach((header, index) => {
                    if (index < limitedCells.length) {
                        const cell = limitedCells[index];
                        rowData[header] = cell && cell.v !== null && cell.v !== undefined ? 
                                          String(cell.v) : '';
                    } else {
                        rowData[header] = '';
                    }
                });
                
                result.push(rowData);
            }
            
            return result;
        }

        /**
         * Filters the data based on the search query.
         * @param {string} query - The search term.
         * @param {Array<Object>} data - The dataset to search within.
         * @returns {Array<Object>} The filtered results.
         */
        function filterData(query, data) {
            const lowerCaseQuery = query.toLowerCase().trim();
            if (!lowerCaseQuery) {
                return []; // Return nothing if search is empty
            }
            return data.filter(row => {
                // Check if any value in the row object includes the query
                return Object.values(row).some(value =>
                    value && value.toLowerCase().includes(lowerCaseQuery)
                );
            });
        }

        /**
         * Renders the search results into cards.
         * @param {Array<Object>} results - The data to display.
         * @param {string} sheetName - The name of the current sheet.
         */
        function renderResults(results, sheetName) {
            // Clear previous results
            resultsCards.innerHTML = ''; 
            noResults.classList.add('hidden');
            cardsContainer.classList.add('hidden');

            if (results.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }
            
            // Update results count and current sheet
            resultsCount.textContent = `${results.length} نتيجة`;
            currentSheet.textContent = sheetName;
            
            cardsContainer.classList.remove('hidden');
            cardsContainer.classList.add('fade-in');

            results.forEach((row, index) => {
                const card = document.createElement('div');
                card.className = 'result-card bg-white rounded-xl border border-gray-200 overflow-hidden fade-in';
                card.style.animationDelay = `${index * 0.1}s`;
                
                let cardContent = `
                    <div class="p-5 border-b border-gray-100 bg-blue-50">
                        <h3 class="text-lg font-bold text-blue-700">نتيجة ${index + 1}</h3>
                    </div>
                    <div class="p-5">
                `;
                
                // Add each field as a row in the card
                Object.entries(row).forEach(([key, value]) => {
                    if (key && key.trim() !== '' && value && value.trim() !== '') {
                        cardContent += `
                            <div class="mb-4 pb-3 border-b border-gray-100 last:border-b-0 last:mb-0 last:pb-0">
                                <div class="text-sm font-semibold text-blue-600 mb-1">${key}</div>
                                <div class="text-gray-700">${value}</div>
                            </div>
                        `;
                    }
                });
                
                cardContent += `</div>`;
                card.innerHTML = cardContent;
                resultsCards.appendChild(card);
            });
        }

        /**
         * The main search handler function.
         */
        async function handleSearch() {
            const query = searchInput.value.trim();
            const selectedSheet = sheetSelect.value;
            
            if (!query) {
                // Show message if search is empty
                noResults.innerHTML = `
                    <div class="text-center my-12 p-8">
                        <div class="bg-blue-50 border border-blue-200 rounded-2xl p-8 max-w-md mx-auto">
                            <i class="fas fa-info-circle text-blue-500 text-5xl mb-4"></i>
                            <h3 class="text-xl font-bold text-blue-800 mb-2">أدخل كلمة للبحث</h3>
                            <p class="text-blue-700">يرجى إدخال كلمة للبحث في قاعدة البيانات.</p>
                        </div>
                    </div>`;
                noResults.classList.remove('hidden');
                cardsContainer.classList.add('hidden');
                return;
            }

            // Check if a sheet is selected
            if (!selectedSheet) {
                noResults.innerHTML = `
                    <div class="text-center my-12 p-8">
                        <div class="bg-orange-50 border border-orange-200 rounded-2xl p-8 max-w-md mx-auto">
                            <i class="fas fa-exclamation-triangle text-orange-500 text-5xl mb-4"></i>
                            <h3 class="text-xl font-bold text-orange-800 mb-2">يرجى اختيار نوع الزيارة</h3>
                            <p class="text-orange-700">يجب اختيار نوع الزيارة الميدانية قبل إجراء البحث.</p>
                        </div>
                    </div>`;
                noResults.classList.remove('hidden');
                cardsContainer.classList.add('hidden');
                return;
            }

            const data = await fetchSheetData(selectedSheet);
            if (data.length > 0) {
                const results = filterData(query, data);
                renderResults(results, selectedSheet);
            } else {
                noResults.innerHTML = `
                    <div class="text-center my-12 p-8">
                        <div class="bg-red-50 border border-red-200 rounded-2xl p-8 max-w-md mx-auto">
                            <i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4"></i>
                            <h3 class="text-xl font-bold text-red-800 mb-2">لا توجد بيانات</h3>
                            <p class="text-red-700">لم يتم تحميل أي بيانات. يرجى التحقق من اتصال الإنترنت والمحاولة مرة أخرى.</p>
                        </div>
                    </div>`;
                noResults.classList.remove('hidden');
                cardsContainer.classList.add('hidden');
            }
        }
        
        // --- EVENT LISTENERS ---
        searchButton.addEventListener('click', handleSearch);
        
        // Allow searching by pressing Enter key
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                handleSearch();
            }
        });

        // عند تغيير ورقة العمل، عرض عدد الزيارات مباشرة
sheetSelect.addEventListener('change', async () => {
    cardsContainer.classList.add('hidden');
    noResults.classList.add('hidden');

    const selectedSheet = sheetSelect.value;

    if (!selectedSheet) {
        // إذا لم يتم اختيار أي ورقة، إخفاء عداد الزيارات إن كان موجوداً
        const visitCountElement = document.getElementById('visitCount');
        if (visitCountElement) {
            visitCountElement.style.display = 'none';
        }
        return;
    }

    // جلب البيانات (مع الكاش التلقائي)
    const data = await fetchSheetData(selectedSheet);

    // حساب عدد الصفوف التي تحتوي على بيانات
    const validRows = data.filter(row =>
        Object.values(row).some(value => value && value.trim() !== '')
    );
    const visitCount = validRows.length;

    // إنشاء أو تحديث العنصر الذي يعرض العدد
    let visitCountElement = document.getElementById('visitCount');
    if (!visitCountElement) {
        const searchSection = document.querySelector('.flex.flex-col.md\\:flex-row.gap-4.mb-2');
        if (searchSection) {
            visitCountElement = document.createElement('div');
            visitCountElement.id = 'visitCount';
            visitCountElement.className = 'text-right mt-3 text-gray-700 font-semibold text-lg';
            visitCountElement.innerHTML = `
                <span class="text-blue-700">عدد الزيارات الميدانية:</span> 
                <span class="text-gray-900">${visitCount}</span>
            `;
            searchSection.insertAdjacentElement('afterend', visitCountElement);
        }
    } else {
        visitCountElement.style.display = 'block';
        visitCountElement.innerHTML = `
            <span class="text-blue-700">عدد الزيارات الميدانية:</span> 
            <span class="text-gray-900">${visitCount}</span>
        `;
    }
});


        // Add sample data for testing if needed
        function addSampleData() {
            // This is just for testing if the real data doesn't load
            sheetData = {
                "تربية الدواجن اللاحم": [
                    { 
                        "اسم الدواء": "أموكسيسيلين", 
                        "الجرعة": "20 مجم/كجم", 
                        "الاستخدام": "علاج الالتهابات البكتيرية", 
                        "مدة العلاج": "3-5 أيام",
                        "التحذيرات": "لا يستخدم في الدواجن المنتجة للبيض",
                        "التأثيرات الجانبية": "نادراً ما تظهر تأثيرات جانبية"
                    },
                    { 
                        "اسم الدواء": "تيانول", 
                        "الجرعة": "1 جم/لتر ماء", 
                        "الاستخدام": "خافض للحرارة", 
                        "مدة العلاج": "3-5 أيام فقط",
                        "التحذيرات": "يجب عدم تجاوز الجرعة المحددة",
                        "التأثيرات الجانبية": "قد يسبب اضطرابات هضمية"
                    }
                ],
                "تربية الدواجن البياض": [
                    { 
                        "اسم الدواء": "فيتامين أ", 
                        "الجرعة": "10000 وحدة/كجم علف", 
                        "الاستخدام": "تحسين النمو والمناعة", 
                        "مدة العلاج": "مستمر في العلف",
                        "التحذيرات": "جرعة زائدة تسبب تسمم",
                        "التأثيرات الجانبية": "لا توجد عند الاستخدام بالجرعات الموصى بها"
                    },
                    { 
                        "اسم الدواء": "كالسيوم", 
                        "الجرعة": "3-4% في العلف", 
                        "الاستخدام": "تقوية قشرة البيض", 
                        "مدة العلاج": "مستمر في العلف",
                        "التحذيرات": "نقصه يضعف قشرة البيض",
                        "التأثيرات الجانبية": "لا توجد عند الاستخدام بالجرعات الموصى بها"
                    }
                ]
            };
            console.log('Sample data loaded for testing');
        }

        // Uncomment the line below to use sample data for testing
        // window.addEventListener('load', addSampleData);

    </script>
</body>

</html>
